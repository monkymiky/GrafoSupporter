<div
  class="card combination-card no-rounded mb-3"
  [class.is-expanded]="isExpanded"
>
  <div class="combination-row row g-0">
    <div class="signs-column col-auto" (click)="toggleExpand()">
      @for (sign of combination.signs; track sign.name; let i = $index) {

      <div>
        <ng-template #tipContent>
          @switch( sign.classification){ @case ("S") {Sostanziale} @case ("M") {
          Modificante } @case ("A") {Accidentale} @default {non classificato}
          }</ng-template
        >
        <div
          [ngbTooltip]="isTooltipDisabled ? null : tipContent"
          placement="end"
          class="d-flex z-3"
        >
          @if(sign.isOptional == true){
          <ng-template #tipContent2>
            segno opzionale per la combinazione</ng-template
          >
          <div
            [ngbTooltip]="tipContent2"
            placement="top"
            container="body"
            class="d-flex z-3"
          >
            <i class="bi bi-plus-circle text-secondary"></i>
          </div>
          }

          <div
            [class.ms-4]="!sign.isOptional"
            [class.ms-2]="sign.isOptional"
            [class.text-success]="sign.temperamento == 'Attesa'"
            [class.text-danger]="sign.temperamento == 'Assalto'"
            [class.text-purple]="sign.temperamento == 'Resistenza'"
            [class.text-info]="sign.temperamento == 'Cessione'"
            class="me-2 sign-name"
          >
            {{ sign.name }}
          </div>
          <div class="text-nowrap sign-grado">
            {{ sign.min }}-{{ sign.max }}/10
          </div>
        </div>
      </div>
      }
    </div>

    <div class="description-column col" (click)="toggleExpand()">
      <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
          <p class="fw-bold mb-1">{{ combination.title }}</p>

          <p class="text-muted mb-0" [class.hidden]="!isExpanded">
            {{ combination.shortDescription }}
          </p>
          <div class="d-flex align-items-center gap-2 author-block">
            @if (combination.author?.pictureUrl) {
            <img
              [src]="combination.author?.pictureUrl"
              alt="Immagine profilo autore"
              class="rounded-circle"
              style="width: 32px; height: 32px; object-fit: cover"
              crossorigin="anonymous"
              referrerpolicy="no-referrer"
              (error)="onAuthorImageError($event)"
            />
            } @else if (combination.author) {
            <span
              class="author-placeholder rounded-circle d-flex align-items-center justify-content-center"
              aria-hidden="true"
            >
              <i class="bi bi-person"></i>
            </span>
            }
            <span>{{ combination.author?.name || 'N/A' }}</span>
          </div>
        </div>

        <div class="vote-section d-flex flex-column align-items-center ms-3" (click)="$event.stopPropagation()">
          <button
            type="button"
            class="btn btn-link p-0 vote-button vote-button-up"
            [class.active]="combination.voteStats?.userVote === 'UP'"
            [disabled]="!canVote()"
            (click)="handleVote('UP')"
            [title]="!canVote() ? 'Non puoi votare le tue combinazioni' : 'Vota positivamente'"
          >
            <i class="bi bi-arrow-up-circle fs-4"></i>
          </button>
          <ng-template #voteRatioTooltip>
            Il rapporto mostra il numero di voti positivi (frecce su) rispetto ai voti negativi (frecce giù). Le combinazioni sono ordinate in base a questo rapporto: più frecce su e meno frecce giù determinano una posizione migliore nella ricerca.
          </ng-template>
          <div
            class="vote-count text-center"
            [ngbTooltip]="isTooltipDisabled ? null : voteRatioTooltip"
            placement="top"
            container="body"
            tooltipClass="tooltip-black"
          >
            <div class="small">
              <span class="text-success">{{ combination.voteStats?.upvotes ?? 0 }}</span> /
              <span class="text-danger">{{ combination.voteStats?.downvotes ?? 0 }}</span>
            </div>
          </div>
          <button
            type="button"
            class="btn btn-link p-0 vote-button vote-button-down"
            [class.active]="combination.voteStats?.userVote === 'DOWN'"
            [disabled]="!canVote()"
            (click)="handleVote('DOWN')"
            [title]="!canVote() ? 'Non puoi votare le tue combinazioni' : 'Vota negativamente'"
          >
            <i class="bi bi-arrow-down-circle fs-4"></i>
          </button>
        </div>

        <i
          class="bi bi-chevron-down ms-3 chevron-icon"
          [class.rotated]="isExpanded"
        ></i>
      </div>
    </div>
  </div>

  @if (isExpanded) {
  <div class="combination-body row g-0 bg-light-title">
    @if(combination.sourceBook){
    <div class="signs-column-body col-auto">
      <p class="fw-bold">Condizione testuale originale:</p>
      <p>{{ combination.originalTextCondition }}</p>
    </div>
    }
    <div class="col description-column-body">
      @if(!combination.sourceBook){
      <div class="float-md-end d-flex gap-1 flex-column mb-3 ms-3">
        <button
          type="button"
          (click)="this.openConfirmDeletionModal()"
          class="btn btn-outline-danger"
        >
          <i class="bi bi-trash"></i>
        </button>
        <button
          type="button"
          class="btn btn-outline-warning"
          (click)="openModifyModal()"
        >
          <i class="bi bi-pencil-square"></i>
        </button>
      </div>
      }

      <p>{{ combination.longDescription }}</p>

      @if(combination.imagePath) {
      <img
        [src]="'/api/files/combination-image/' + combination.imagePath"
        [alt]="'Immagine di una scrittura con ' + combination.title"
        class="img-fluid mb-3"
      />
      }

      @if(this.combination.sourceBook?.title){
      <p>
        Fonte: {{ this.combination.sourceBook?.title }}; Editore:
        {{ this.combination.sourceBook?.editor }}; ISBN:
        {{ this.combination.sourceBook?.isbn }}.
      </p>
      }

      @if(combination.id) {
      <app-comment-section
        [combinationId]="combination.id"
        [attr.data-combination-id]="combination.id"
      ></app-comment-section>
      }
    </div>
  </div>

  }
</div>
