<div class="comment-section mt-3">
  <button
    type="button"
    class="btn btn-link p-0 text-decoration-none d-flex align-items-center"
    (click)="toggleSection()"
    [attr.aria-expanded]="isOpen"
  >
    <i class="bi bi-chat-dots me-2"></i>
    <span>Commenti</span>
    @if (comments.length > 0) {
    <span class="badge bg-secondary ms-2">{{ comments.length }}</span>
    }
    <i
      class="bi ms-2"
      [class.bi-chevron-down]="!isOpen"
      [class.bi-chevron-up]="isOpen"
    ></i>
  </button>

  @if (isOpen) {
  <div class="comment-section-content mt-3">
    @if (isLoading) {
    <div class="text-center py-3">
      <div class="spinner-border spinner-border-sm" role="status">
        <span class="visually-hidden">Caricamento...</span>
      </div>
    </div>
    } @else {
    @if (isAuthenticated) {
    <div class="comment-form mb-3">
      <textarea
        class="form-control"
        rows="3"
        placeholder="Scrivi un commento..."
        [(ngModel)]="newCommentContent"
        [disabled]="isSubmitting"
        maxlength="2000"
      ></textarea>
      <div class="d-flex justify-content-between align-items-center mt-2">
        <small class="text-muted">{{ newCommentContent.length }}/2000</small>
        <button
          type="button"
          class="btn btn-primary btn-sm"
          (click)="submitComment()"
          [disabled]="!newCommentContent.trim() || isSubmitting"
        >
          @if (isSubmitting) {
          <span
            class="spinner-border spinner-border-sm me-2"
            role="status"
            aria-hidden="true"
          ></span>
          }
          Pubblica
        </button>
      </div>
    </div>
    }

    <div class="comments-list">
      @if (comments.length === 0) {
      <p class="text-muted text-center py-3">Nessun commento ancora. Sii il primo a commentare!</p>
      } @else {
      @for (comment of comments; track comment.id) {
      <app-comment-item
        [comment]="comment"
        [combinationId]="combinationId"
        (commentAdded)="onCommentAdded($event)"
      ></app-comment-item>
      }
      }
    </div>
    }
  </div>
  }
</div>
